<html>
   <head>
      <link rel="stylesheet" type="text/css" href="reset.css" />
      <link rel="stylesheet" type="text/css" href="app.css" />
      <script src="jquery-1.6.3.min.js"></script>
      <script src="seedrandom-min.js"></script>

   </head>
   <body>
      <div id="rejects">
      </div>
      <div id="numbers">
      </div>
      <div id="debug">
      </div>
      <div id="controls">
         <input type="button" id="start" value="START"/>
         <input type="button" id="reload" value="Reload"/><br>
         <div class="tohide">
         Create tickets: <input type="text" id="count" value="300"/><br>
         Number of Columns: <input type="text" id="columns" value="10"/> <input type="button" id="create" value="Create"><br>
      </div>
         Speed: <input type="text" id="speed" value="5000"/><br>
         <div class="tohide">
         Random Seed: <input type="text" id="seed" value="CSC Gala 2011"/><br>
      </div>
         Stop At: <input type="text" id="stop" value="10"/><br>
         Manually Eliminate <input type="text" id="elcount" value="1"/> <input type="button" id="next" value="Eliminate"/><br>
      </div>
      <script>
         Math.seedrandom($('#seed').attr('value'));
         $('#seed').change(function() {
            Math.seedrandom($('#seed').attr('value'));
         });
         function resizetime() {
            return 1000;
         }

         function zeroFill(num) {
            if(num < 10) {
               return "00" + num;
               } else if(num < 100) {
               return "0" + num;
               } else {
               return String(num);
            }
         }

         function resizeSmoothly(element) {
            var units = "px";
            var winheight = window.innerHeight * 0.90 - element.offset().top;
            var was = element.css('font-size');
            var pxsize = Number(was.substr(0,was.length-2));
            //$('#marker').css('top',winheight);

            var maxwidth = $('#rejects').offset().left;

            element.css('font-size',String(pxsize) + units);

            var min = 10;
            var max = 300;
            while(max - min > 0.001) {
               var totry = (max + min) / 2.0;
               element.css('font-size',String(totry) + units);

               var diff = element.height() - winheight;
               if(element.width() > maxwidth) {
                  diff = 1;
               }
               if(diff == 0) {
                  break;
               } else if(diff < 0) {
                 min = totry;
               } else {
                 max = totry;
               }
            }
            element.css('font-size',was);

            //animate(1,pxsize);
            var size = String((max + min) / 2.0) + units;
            element.animate({fontSize:size},resizetime());
            //n.css('font-size',size);
         }

         var count = 300;
         var columns = 10;
         var numbers = new Array;
         var items_per_column;
         function createTickets() {
           $('#start').attr('disabled',false);
            count = parseInt($('#count').attr('value'));
            columns = parseInt($('#columns').attr('value'));

         var html = "<h1>Tickets In Play</h1><table id='inplay'><tr>";
         var rhtml = "<h1>Eliminated Tickets</h1><table id='eliminated'><tr>";
         for(var i=0;i<columns;++i) {
            html += "<td id='fromtd" + i + "'><ul id='from" + i + "'></ul>" + "</td>"
            rhtml += "<td><ul id='to" + i + "'></ul>" + "</td>"
         }
         html += "</tr></table>";
         rhtml += "</tr></table>";
         $('#numbers').html(html);
         $('#rejects').html(rhtml);

         items_per_column = count / columns;
         if(items_per_column > Math.floor(items_per_column)) {
            items_per_column = Math.floor(items_per_column) + 1;
         }
         numbers = new Array;
         for(var i=0;i<count;++i) {
            var number = zeroFill(i);
            html = "<li id='n" + i + "' class='n'>" + number + "</li>"
            var column = Math.floor(i / items_per_column);
            $('#from' + column).append(html)
            numbers.push("#n" + i);
         }

         resizeSmoothly($('#inplay'));
         }

         function removeIfChildrenEmpty(el) {
             if(el) {
               if(el.children().length == 0) {
                 el.remove();
               }
             }
         }

         function removeEmptyColumns() {
           for(var i=0;i<columns;i++) {
              removeIfChildrenEmpty($('#from' + i));
              removeIfChildrenEmpty($('#fromtd' + i));
           }
         }

         function removeOne(resize) {
         if(numbers.length <= 1) {
         return;
         }
           var rand = Math.random();
            var index = Math.floor(rand * (numbers.length));
            
            var el = $(numbers[index]);
            numbers.splice(index,1);

            try {

            //el.html("remove");
            var divid = 'reject' + el.attr('id');
            var newel = "<li id='" + divid + "'>" + el.html() + "</li>";
            $('#numbers').append(newel);
            newel = $("#" + divid);
            var pos = el.offset();
            var rejectcolumn = Math.floor((count - numbers.length) / items_per_column);
            var rejectel = $('#to' + rejectcolumn);
            var rejectpos = rejectel.offset();
            newel.css({position: 'absolute',
               fontSize: el.css('font-size'),
               marginLeft: 0, marginTop: 0,
               top: pos.top, left: pos.left });
            var cursize = el.css('font-size');
            cursize = cursize.substr(0,cursize.length-2);
            } catch(e) {
            console.log("Caught exception for index " + index + " with length " + numbers.length + " random is " + rand);
            console.log("count is " + count);
            }

            el.css('color','black');

            var sizemultiplier = 4;
            var enlargedsize = cursize * sizemultiplier;

            newel.animate({fontSize:String(enlargedsize) + "px"},resizetime() * 2).animate({fontSize:rejectel.css('font-size'), left: rejectpos.left, top: rejectpos.top + rejectel.height()},{duration: resizetime, complete: function() { 
                  el.remove(); 
                  if(resize) {
                    removeEmptyColumns();
                    resizeSmoothly($('#inplay')); 
                  }
                  newel.appendTo(rejectel);
                  newel.css({position: 'relative', top: 0, left: 0, fontSize: ""}); 
               }
            });
            el.animate({fontSize:String(enlargedsize) + "px"},resizetime() * 2).animate({fontSize:"0"},resizetime());
            //resizeSmoothly(count);
         }

         function stopAt() {
            return parseInt($('#stop').attr('value'));
            }

         function doremove() {
            var ms = parseInt($('#speed').attr('value'));
            setTimeout(function() {
            if(numbers.length < stopAt()) {
                  return;
               }
               removeOne(true);
               doremove();
            },ms);
         }
         $('#create').click(createTickets);
         $('#start').attr('disabled',true);
         
         $('#start').click(function() {
         $('#controls').fadeTo(500,0.75);
         $('.tohide').hide();
         $('#start').attr('disabled',true);
         doremove();
         });
         $('#reload').click(function() {
           location.reload();
         });
         //removeOne();

         /*
         function handleKey(event) {
            if(event.keyCode == 110) {
            if(numbers.length > parseInt($('#stop').attr('value')) {
               removeOne(false);
            }
               } else if(event.keyCode == 114) {
                    resizeSmoothly($('#inplay')); 
               } else {
               alert("Unknown key pressed " + event.keyCode);
               }
         }

         $('#numbers').keypress(handleKey);
         */

         $('#next').click(function() {
         var count = parseInt($('#elcount').attr('value'));
         for(var i=0;i<count-1;++i) {
           removeOne(false)
           }
           removeOne(true)
         });

      </script>
   </body>
</html>
